<!doctype html>
<html lang="zh-Hant" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-prosemirror/guide" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.5.2">
<title data-rh="true">proseMirror guide 翻譯 | P&amp;P 的 筆記</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://blog.papersuniverse.com/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://blog.papersuniverse.com/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://blog.papersuniverse.com/docs/prosemirror/guide"><meta data-rh="true" property="og:locale" content="zh_Hant"><meta data-rh="true" name="docusaurus_locale" content="zh-Hant"><meta data-rh="true" name="docsearch:language" content="zh-Hant"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="proseMirror guide 翻譯 | P&amp;P 的 筆記"><meta data-rh="true" name="description" content="自己的整理"><meta data-rh="true" property="og:description" content="自己的整理"><link data-rh="true" rel="icon" href="/img/ico-star.png"><link data-rh="true" rel="canonical" href="https://blog.papersuniverse.com/docs/prosemirror/guide"><link data-rh="true" rel="alternate" href="https://blog.papersuniverse.com/docs/prosemirror/guide" hreflang="zh-Hant"><link data-rh="true" rel="alternate" href="https://blog.papersuniverse.com/docs/prosemirror/guide" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.069b8a9f.css">
<script src="/assets/js/runtime~main.69c2901e.js" defer="defer"></script>
<script src="/assets/js/main.4cb1b457.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const n=new URLSearchParams(window.location.search).entries();for(var[t,e]of n)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="跳至主要内容"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">跳至主要内容</a></div><nav aria-label="主導航" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="切換導覽列" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.svg" alt="My Site Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/img/logo.svg" alt="My Site Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">P&amp;P的筆記</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/category/prosemirror">文章列表</a></div><div class="navbar__items navbar__items--right"><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="切換淺色/深色模式（當前為淺色模式）" aria-label="切換淺色/深色模式（當前為淺色模式）" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="回到頂部" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="文件側邊欄" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" href="/docs/category/prosemirror">ProseMirror</a><button aria-label="收起側邊欄分類 &#x27;ProseMirror&#x27;" aria-expanded="true" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/prosemirror/guide">proseMirror guide 翻譯</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs/category/react-學習筆記">React 學習筆記</a><button aria-label="展開側邊欄分類 &#x27;React 學習筆記&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li></ul></nav></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="頁面路徑"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="主頁面" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/docs/category/prosemirror"><span itemprop="name">ProseMirror</span></a><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">proseMirror guide 翻譯</span><meta itemprop="position" content="2"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">本頁導覽</button></div><div class="theme-doc-markdown markdown"><header><h1>proseMirror guide 翻譯</h1></header>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="自己的整理">自己的整理<a href="#自己的整理" class="hash-link" aria-label="自己的整理的直接連結" title="自己的整理的直接連結">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="plugin--node-view--decoration-的差異">plugin / node view / decoration 的差異<a href="#plugin--node-view--decoration-的差異" class="hash-link" aria-label="plugin / node view / decoration 的差異的直接連結" title="plugin / node view / decoration 的差異的直接連結">​</a></h3>
<p>plugin 用來改變編輯器的文檔，可以加一些按鍵綁定、修改編輯器的狀態...
node view 為特定節點擴展自定義的結構
decoration 將文檔添加視覺效果</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="介紹">介紹<a href="#介紹" class="hash-link" aria-label="介紹的直接連結" title="介紹的直接連結">​</a></h2>
<p>ProseMirror 提供了能完成文字編輯器的一系列工具與概念。</p>
<p>PM 的主要原則是讓 code 能有完全對於 document 的掌控，能完全知道發生什麼事。document 不是 html，是指一個自訂的資料結構，這個結構可以規範什麼樣的 DOM 可以包含在結構中，所有的更新都經過一個特定的點，讓你可以觀察與回應。</p>
<p>core module 的設計是以模組化與客製化的能力為主要考量。</p>
<p>有 4 個重要的 module，進行任何編輯都需要這些。還有一些額外的插件，但可以忽略，如果你只需要做一些簡單的功能。或者你也可以自己做一個相關插件取代。</p>
<p>重要的 module 包含：</p>
<ol>
<li>
<p>prosemirror-model
定義用來描述編輯器內容的文件模型，是 state 的一部分。</p>
</li>
<li>
<p>prosemirror-state
提供描述整個編輯器狀態的資料結構，包括選取範圍與狀態改變的變更機制（transaction system）。</p>
</li>
<li>
<p>prosemirror-view
實現了可以顯示 editor state 的 ui 介面，使用 html editable element，並處理使用者互動。</p>
</li>
<li>
<p>prosemirror-transform
提供可以修改 document 的功能，並且可以被紀錄與重複，這是 state module 的 transaction system 的基礎，也是有這些功能，使協作功  能、復原功能可以實現</p>
</li>
</ol>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="transactions">transactions<a href="#transactions" class="hash-link" aria-label="transactions的直接連結" title="transactions的直接連結">​</a></h3>
<p>當使用者與 view 互動時，會產生 state transaction，代表在更改 state 時，並不是在內部更改 document 的狀態，而是將每個改變都 create 一個 transaction。transaction 就是描述與原 state 的差異，可以被 state apply 成一個新的 state。</p>
<p>預設的上述的機制都發生在幕後。可以寫 <strong>plugin</strong> 或是 <strong>設定自己的 view</strong> 來 hook。
例如：dispatchTransaction，是 EditorView  可傳入的參數，dispatchTransaction 是一個 callback，在 transaction 被創建時觸發。</p>
<p>每一次 state 的更新，都透過 EditorView.updateState，每一個編輯更新都由 dispatch transaction 觸發。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="plugins">plugins<a href="#plugins" class="hash-link" aria-label="plugins的直接連結" title="plugins的直接連結">​</a></h3>
<p>plugin 透過不同的方式來擴充編輯器與編輯器狀態。有些特別簡單，像是 keymap plugin。有些則是涉入較多，像是 history plugin。因為 plugin 在創立 state 時註冊，因為 plugin 可以取得 state transaction。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="commands">commands<a href="#commands" class="hash-link" aria-label="commands的直接連結" title="commands的直接連結">​</a></h3>
<p>大部分的編輯動作都是一個 command。
prosemirror command 提供一系列基本的編輯 command，也包含一些基本的操作功能包（baseKeymap），像是 delete, enter 等。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="content">content<a href="#content" class="hash-link" aria-label="content的直接連結" title="content的直接連結">​</a></h3>
<p>整個編輯器的 document state 是存在 EditorState.doc 裡。這是一個唯讀的資料結構，用多層級的 node 表示 document，類似於 DOM 結構。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="documents">Documents<a href="#documents" class="hash-link" aria-label="Documents的直接連結" title="Documents的直接連結">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="structure">Structure<a href="#structure" class="hash-link" aria-label="Structure的直接連結" title="Structure的直接連結">​</a></h3>
<p>PM document 是一個 class Node。
class Node 有 property content 是 class Fragment
而 Fragment 有 property content 是 [NODE]</p>
<p>Fragment 是代表 子 node 的集合</p>
<p>node 與 fragment 都是 persistent 的特性。這意味著我們不該 mutate 它。</p>
<p>如果是這樣一段 html
<code>&lt;p&gt;This is &lt;strong&gt;strong text with &lt;em&gt;emphasis&lt;/em&gt; &lt;/strong&gt;&lt;/p&gt;</code>
在 DOM Tree 裡概念上是這樣</p>
<div class="language-js= codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-js= codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    type: &#x27;p&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    content: [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            type: &#x27;text&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            text: &#x27;This is&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            type: &#x27;strong&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            content: [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    type: &#x27;text&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    text: &#x27;strong text with&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    type: &#x27;em&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    content: [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            type: &#x27;text&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            text: &#x27;emphasis&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    ]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="複製程式碼至剪貼簿" title="複製" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>但在 ProseMirror 概念是這樣</p>
<div class="language-js= codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-js= codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    type: &#x27;p&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    content: [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            type: &#x27;text&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            text: &#x27;This is&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            type: &#x27;text&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            text: &#x27;strong text with&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            mark: [{ type: &#x27;strong&#x27; }]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            type: &#x27;text&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            text: &#x27;emphasis&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            mark: [{ type: &#x27;strong&#x27; }, { type: &#x27;em&#x27; }]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="複製程式碼至剪貼簿" title="複製" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>所以實際上，ProseMirror 把 inline 元素 flatten 了，ProseMirror document 實際上是 block 元素的樹狀結構。</p>
<p>這更符合我們傾向於思考和處理此類文本的方式。它允許我們使用字元偏移量而不是樹中的路徑來表示段落中的位置，並且可以更輕鬆地執行拆分或更改內容樣式等操作，而無需執行笨拙的樹操作。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="document-transformations">Document transformations<a href="#document-transformations" class="hash-link" aria-label="Document transformations的直接連結" title="Document transformations的直接連結">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="steps">steps<a href="#steps" class="hash-link" aria-label="steps的直接連結" title="steps的直接連結">​</a></h3>
<p>更新 docuement 這個行為，可以分解成多個 <code>step</code>，通常不需要直接用到 <code>step</code>，但知道如何實作是有用的。</p>
<p>steps 的例子：用 <code>replaceStep</code> 取代 document 中的一塊。
step 可以被 apply 進 document，建立一個新的 document</p>
<div class="language-js= codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-js= codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">console.log(myDoc.toString()); // p(&#x27;hello&#x27;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// A step that deletes the content between position 3 and 5</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">let step = new ReplaceStep(3, 5, Slice.empty);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">let result = step.apply(mydoc);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">console.log(result.doc.toString()); // p(&#x27;heo&#x27;)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="複製程式碼至剪貼簿" title="複製" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>apply step 是一個相對直觀的行為，意思是，是有可能會報錯的。例如：如果嘗試刪除 opening token（<code>&lt;p&gt;</code> 標籤），可能會導致 token 不平衡。這也是為什麼 apply 會回傳一個 result object。result 會在成功時回傳 doc，失敗時回傳 error message。</p>
<p>通常會習慣使用 Transform 提供的一系列 helper function 處理 step，這樣就不用顧慮太多細節。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="transform">Transform<a href="#transform" class="hash-link" aria-label="Transform的直接連結" title="Transform的直接連結">​</a></h3>
<p>一個編輯動作，可能會產生一個或多個 step。
如果要操作一系列的 step，最方便的方式是使用 Transform。</p>
<p>Transform 這個 class 就是用來建立與追蹤一系列 step 的抽象</p>
<div class="language-js= codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-js= codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">let tr = new Transform(myDoc);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tr.delete(5, 7); // delete between position 5 and 7</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tr.split(5); // split the parent node at position 5</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">console.log(tr.doc.toString()); // The modeified document</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">console.log(tr.steps.length); // 2</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="複製程式碼至剪貼簿" title="複製" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>transform 大部分的 method 都會回傳自己，也就是可以把方法 chain 起來。
<code>tr.delete(5, 7).split(5)</code></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="mapping">Mapping<a href="#mapping" class="hash-link" aria-label="Mapping的直接連結" title="Mapping的直接連結">​</a></h3>
<p>當改變 document，每個 postion index 其實也會改變。例如插入一個字元或是刪除字元，都會導致整個 doc 的 index 與之前不一樣。</p>
<p>通常會需要在文字的變更中，保留位置。ex: selection boundaries。
為了這個需求，proseMirror 的 step 提供 <a href="https://prosemirror.net/docs/ref/#transform.StepMap" target="_blank" rel="noopener noreferrer">map</a>，
可以透過比較改變前後的 index 變化。</p>
<div class="language-js= codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-js= codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">let step = new ReplaceStep(4, 6, Slice.empty); // delete 4-5</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">let map = step.getMap();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">console.log(map.map(8));  // -&gt; 6 (原本是 8 變成 6)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">console.log(map.map(2)); // -&gt; 2 (原本是 2 不變)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="複製程式碼至剪貼簿" title="複製" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Tramsform 有 mapping 這個 property 紀錄了一系列 steps 的 maps。</p>
<div class="language-js= codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-js= codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">let tr = new Transform(myDoc);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tr.split(10) // split a node, +2 tokens at 10</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tr.delete(2, 5) // -3 tokens at 2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">console.log(tr.mapping.map(15)) // -&gt; 14</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">console.log(tr.mapping.map(6)) // -&gt; 3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">console.log(tr.mapping.map(10)) // -&gt; 9</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="複製程式碼至剪貼簿" title="複製" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>某些時候，並不是很清楚原始的 index 要 map 到哪一個位置。例如：前面例子 index 10，究竟應該把 10 放在分割的後面或者是前面。</p>
<p>如果其實 index 10 應該在前面，可以這樣做 <code>tr.mapping.map(10, -1)</code></p>
<p>將各種 step 定義的小而直觀的原因是，讓這樣子的 mapping 紀錄可以實現。甚至可以反轉 step。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="rebasing">Rebasing<a href="#rebasing" class="hash-link" aria-label="Rebasing的直接連結" title="Rebasing的直接連結">​</a></h3>
<p>當透過 step   或是 position map 實作較複雜的行為，例如：追蹤變更紀錄，或是在多人協作中增加其他功能，可能會使用到 rebase steps。</p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>資訊</div><div class="admonitionContent_BuS1"><p>太抽象了，有實作這段，再來說明</p></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="the-editor-state">The editor state<a href="#the-editor-state" class="hash-link" aria-label="The editor state的直接連結" title="The editor state的直接連結">​</a></h2>
<p>編輯器要記得狀態有哪些，如何文章的資料結構（document）外，還有 current selection、目前 mark 的狀態。
ProseMirror state 有 3 個主要的狀態就是 doc, selection, storeMarks。</p>
<p>plugin 也需要儲存 state。undo history 也需要記得歷史紀錄。這就是為什麼 editorState 裡，也有儲存目前 active 的 plugin。這些 plugin 也可以儲存 plugin 自己的 state。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="selection">Selection<a href="#selection" class="hash-link" aria-label="Selection的直接連結" title="Selection的直接連結">​</a></h3>
<p>PM 支援多種不同的 selection。所有的 selection 都是繼承 Class Selection 的實例。editor state 裡的 selection 也是 immutable 的，要改變 selection，要建一個新的 selection object，與一個新的 state。</p>
<p><code>.from</code>：selection 當中，文本前端的那個 point
<code>.to</code>：selection 當中，文本後端的那個 point
<code>.anchor</code>：selection 當中，一開始釘下的 point，不會動的那個 point
<code>.head</code>：selection   當中，在移動的 point</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="transaction">Transaction<a href="#transaction" class="hash-link" aria-label="Transaction的直接連結" title="Transaction的直接連結">​</a></h3>
<p>在一般正常編輯的時候，newState 會根據舊的 state 產生。</p>
<p>state 可以 apply transaction 來產生新的 state。</p>
<p><code>Transaction</code> 繼承自 <code>Transform</code>，transaction 會追蹤 selection 與其他有狀態的元件，Transaction 實際上被歸類在 prosemirror-state，像是 store marks 的改變，也會追蹤。</p>
<p>我覺得可以說 Transaction 是針對編輯器有加上了一些特化功能的 Transform。</p>
<p>所以 Transaction 有一系列修該編輯器相關狀態的 method。<code>setStoreMarks</code>、<code>ensureMarks</code>、<code>scrollIntoView</code>...等。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="plugins-1">Plugins<a href="#plugins-1" class="hash-link" aria-label="Plugins的直接連結" title="Plugins的直接連結">​</a></h3>
<p>當建一個新的 editorState 時，可以帶入一個 array 設定一系列的 plugin。這些 plugin 會被存在 state 裡面，並且可以在 plugin 裡 apply transaction，或影響 editor 處理 state 的行為。</p>
<div class="language-js= codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-js= codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">let myPlugin = new Plugin({</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    props: {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        handleKeyDown(view, event) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            console.log(&#x27;A key was pressed&#x27;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return false; // We did not handle this</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">});</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">let state = EditorState.create({ schema, plugins: [myPlugin] });</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="複製程式碼至剪貼簿" title="複製" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>plugin 也可以定義自己的 state
所以其實 PM 有分有 state 的 plugin 和沒有 state 的 plugin。
有 state 的 plugin 一定要放在 EditorState 被建立。</p>
<div class="language-js= codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-js= codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">let transactionCounter = new Plugin({</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    state: {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        init() { return 0 },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        apply(tr, value) { return value + 1 }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">})</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">function getTransactionCount(state) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    transactionCounter.getState(state);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="複製程式碼至剪貼簿" title="複製" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>getState 會從整個 editorState 中提取 plugin 的 state。
整個 editor state 是 immutable 的，所以 apply method 需回傳一個新值。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="metadata">metadata<a href="#metadata" class="hash-link" aria-label="metadata的直接連結" title="metadata的直接連結">​</a></h4>
<p>metadata 主要用於對 plugin 在 apply 新的 state 時，加上一些資訊。
metadata 的相關 method 是透過 transaction 處理的。有 <code>tr.getMeta()</code>，<code>tr.setMeta()</code>，
也就是會標記該 transaction 的狀態。</p>
<p>例如：undo history plugin，在進行 執行 undo 時，會標記該 transaction，當 plugin 發現這個 transaction 有被標記時，有別於一般的紀錄更新（把 transaction 加到 undo stack），plugin 會將 undo stack 最上面的 transaction 搬移到 redo stack。</p>
<p>而為了讓 plugin 能夠判斷不同情況，就要用 metadata 來輔助。例如上面的 transactionCounter，如果有特殊的情境要讓 count 不 +1 的話。可以這樣：</p>
<div class="language-js= codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-js= codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">let transactionCounter = new Plugin({</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    state: {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        init() { return 0 },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        apply(tr, value) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (tr.getMeta(transactionCounter)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                return value;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return value + 1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">})</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">function markAsUncounted(tr) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    tr.setMeta(transactionCounter, true);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="複製程式碼至剪貼簿" title="複製" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>setMeta 的 type 定義，實際上 value 可以是 any
setMeta 的 key 推薦使用 Plugin 本身，如果要 string 的話，就要確保其唯一性。
有些 PM 的插件裡面，有用 string 當作 key。</p>
<div class="language-ts= codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-ts= codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">function setMeta(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    key: string | Plugin | PluginKey</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    value: any</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">): Transaction</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="複製程式碼至剪貼簿" title="複製" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="the-view-component">The View Component<a href="#the-view-component" class="hash-link" aria-label="The View Component的直接連結" title="The View Component的直接連結">​</a></h2>
<p>PM editor view 是用來轉換 editor state 至 DOM 的元件。並允許使用者進行一些編輯(editing actions)。</p>
<p>EditorView 元件對於 editing actions 的定義是嚴謹的。主要為直接對編輯器的操作，像是 typing, clicking, copying, pasting, dragging，不超過以上範圍。因此像是，menu，快捷鍵行為綁定等功能，並不屬於 EditorView 元件的職責範圍，需要透過 plugin 來實現。</p>
<p>Browser 透過 contentEditable 可以讓 DOM 元素被編輯，讓元素可以被 focus 與 select，也可以在其中輸入內容。View 將 PM document 轉換為 DOM，並且讓 DOM 的編輯也連動到 editor state 上(ex: selection...)。</p>
<p>EditorView 本身也註冊了許多 DOM events，並將這些 event 轉換為適當的 transaction。例如：貼上這個行為，被貼上的內容會被轉換為 ProseMirror document Slice，並被插入 document 中。</p>
<p>許多事件也被原樣傳遞，然後才跟著 PM 的資料  模型被重新解釋。Browser 對於 cursor 與 selection 的行為十分在行。所以大部分 cursor 的動作都被 browser 處理，在處理完後，PM 才去檢查目前的 DOM selection 是否符合到 PM 的 text selection。假若不符合，便會 dispatch 關於 selection 的 transaction。</p>
<p>一般的打字，也是留給 browser 處理，因為干擾打字可能會破壞瀏覽器提供的原始功能，例：拼字檢查、自動補全...等。editorView 會監聽 browser 的 dom 內容改變後，parse 目前的結構，並生成可以提供修訂原始 state 的 transaction。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="data-flow">Data flow<a href="#data-flow" class="hash-link" aria-label="Data flow的直接連結" title="Data flow的直接連結">​</a></h3>
<p>所以 editorview 將給定的 editor state 顯示出來。當 DOM event 觸發時，editorview 建立 transaction，並且可以透過 apply tr 建立一個新的 state，最後將新的 state 給 view 執行 <code>updateState(state)</code></p>
<p>如上圖是其資料流。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="props">Props<a href="#props" class="hash-link" aria-label="Props的直接連結" title="Props的直接連結">​</a></h3>
<p>props 可以理解為 react props。就是 ui component 的參數。
state 也是一個 prop。所有其他的 props 在運行時都可以被更新。
Plugin 也可以帶入 props，如果 props 被定義了多次（可以從 EditorView 或 Plugin 定義 props），一般來說，會按順序確定 props 的值為何，依序執行。EditorView 為最先的，其次依據 plugin 的順序執行。
如果是 handler function，會一直執行直到 return true 的那一個為止。
對於一些可以有多種值的 props，就會被聚集起來。（ex：attribue, decoration)</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="decorations">Decorations<a href="#decorations" class="hash-link" aria-label="Decorations的直接連結" title="Decorations的直接連結">​</a></h3>
<p>Decoration 讓你可以控制 view 如何顯示文本。但 Decoration 不會在 document 中插入 node，而是有自己的 tree 結構。
Decoration 分成 3 種：</p>
<ol>
<li>Node Decoration：對一個 node DOM 加上 style 或 attribute</li>
<li>Widget Decoration：在給定 position 插入一個 DOM node，這並不在 document 中。</li>
<li>Inline Decoration：類似 Node Decoration，但作用在 inline node 上。</li>
</ol>
<p>為了要有效率的繪製與比對 decorations，需要透過 decotation set 加入 decoration。
decotation set 是一個 Tree 的 資料結構</p>
<div class="language-js= codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-js= codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">let purplePlugin = new Plugin({</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    props: {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        decorations(state) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return DecorationSet.create(state.doc, [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                Decoration.inline(0, state.doc.content.size, { style: &#x27;color: purple&#x27; })</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">})</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="複製程式碼至剪貼簿" title="複製" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>如果有大量 decoration，每次重繪都要透過 DecorationSet recreate 大量 decoration，是耗效能的。針對這種情況，建議把 decorationSet 寫進 plugin state 裡。透過 decorationSet.map 處理。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="node-view">Node View<a href="#node-view" class="hash-link" aria-label="Node View的直接連結" title="Node View的直接連結">​</a></h3>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>資訊</div><div class="admonitionContent_BuS1"><p>自己的理解：node view 是一個內容可以自定義的元件，node view 必須跟 schema 的 spec 搭配。spec 定義外面的 DOM 結構。node view 可以在對內部的內容做客製功能。</p><p>nodeSpec 的 toDOM 定義了外面的 DOM 結構，例：
[&#x27;p&#x27;, 0]
node view 像是可以用 js 調整 0 裡面的東西</p></div></div>
<p>待補</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="commands-1">commands<a href="#commands-1" class="hash-link" aria-label="commands的直接連結" title="commands的直接連結">​</a></h2>
<p>在 PM，command 專指  一個術語，是實現 editor action 的 function。</p>
<p>根據實際情況，command 可以是一個複雜的介面。在簡單的情形下，command 是一個 function 接收 editor state 與 dispatch function 做為參數，並且 return true or false。</p>
<p>為了要知道 command 在給定的 state 下是否可以執行，但又必須確保在確定可執行後，在觸發 dispatch，command 被設計成，如果參數<strong>只有給 state</strong>，command 只會 return true or false，來確定 command 是否可執行。</p>
<p>例：</p>
<div class="language-js= codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-js= codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">function deleteSelection(state, dispatch) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (state.selection.empty) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return false;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (dispatch) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        dispatch(state.tr.deleteSelection);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return true;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="複製程式碼至剪貼簿" title="複製" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>prosemirror-commands 模組提供了許多 editing commands。像是 deleteSelection。也有較複雜的像是 joinBackward。joinBackward 主要是應用在 backspace 鍵觸發時，若在游標置於 textblock 最前方時，要實作 2 個 block 合併的操作。</p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>資訊</div><div class="admonitionContent_BuS1"><p>chainCommad 好難解釋，有機會再補</p></div></div>
<p>有些時候，command 需要跟 view 互動，這時候 command 會再多一個參數 view。
所以 command 完整的 type 是這樣</p>
<div class="language-ts= codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-ts= codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    state: EditorState,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    dispatch: (tr: Transaction) =&gt; void,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    view?: EditorView</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">) =&gt; boolean</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="複製程式碼至剪貼簿" title="複製" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="參考文章">參考文章<a href="#參考文章" class="hash-link" aria-label="參考文章的直接連結" title="參考文章的直接連結">​</a></h2>
<p><a href="https://prosemirror.net/docs/guide/" target="_blank" rel="noopener noreferrer">https://prosemirror.net/docs/guide/</a></p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-edit-meta-row"><div class="col"><a href="https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/prosemirror/guide.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>編輯此頁</a></div><div class="col lastUpdated_JAkA"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="文件選項卡"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/category/prosemirror"><div class="pagination-nav__sublabel">上一頁</div><div class="pagination-nav__label">ProseMirror</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/category/react-學習筆記"><div class="pagination-nav__sublabel">下一頁</div><div class="pagination-nav__label">React 學習筆記</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#自己的整理" class="table-of-contents__link toc-highlight">自己的整理</a><ul><li><a href="#plugin--node-view--decoration-的差異" class="table-of-contents__link toc-highlight">plugin / node view / decoration 的差異</a></li></ul></li><li><a href="#介紹" class="table-of-contents__link toc-highlight">介紹</a><ul><li><a href="#transactions" class="table-of-contents__link toc-highlight">transactions</a></li><li><a href="#plugins" class="table-of-contents__link toc-highlight">plugins</a></li><li><a href="#commands" class="table-of-contents__link toc-highlight">commands</a></li><li><a href="#content" class="table-of-contents__link toc-highlight">content</a></li></ul></li><li><a href="#documents" class="table-of-contents__link toc-highlight">Documents</a><ul><li><a href="#structure" class="table-of-contents__link toc-highlight">Structure</a></li></ul></li><li><a href="#document-transformations" class="table-of-contents__link toc-highlight">Document transformations</a><ul><li><a href="#steps" class="table-of-contents__link toc-highlight">steps</a></li><li><a href="#transform" class="table-of-contents__link toc-highlight">Transform</a></li><li><a href="#mapping" class="table-of-contents__link toc-highlight">Mapping</a></li><li><a href="#rebasing" class="table-of-contents__link toc-highlight">Rebasing</a></li></ul></li><li><a href="#the-editor-state" class="table-of-contents__link toc-highlight">The editor state</a><ul><li><a href="#selection" class="table-of-contents__link toc-highlight">Selection</a></li><li><a href="#transaction" class="table-of-contents__link toc-highlight">Transaction</a></li><li><a href="#plugins-1" class="table-of-contents__link toc-highlight">Plugins</a></li></ul></li><li><a href="#the-view-component" class="table-of-contents__link toc-highlight">The View Component</a><ul><li><a href="#data-flow" class="table-of-contents__link toc-highlight">Data flow</a></li><li><a href="#props" class="table-of-contents__link toc-highlight">Props</a></li><li><a href="#decorations" class="table-of-contents__link toc-highlight">Decorations</a></li><li><a href="#node-view" class="table-of-contents__link toc-highlight">Node View</a></li></ul></li><li><a href="#commands-1" class="table-of-contents__link toc-highlight">commands</a></li><li><a href="#參考文章" class="table-of-contents__link toc-highlight">參考文章</a></li></ul></div></div></div></div></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/wen0720" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2024 P&P筆記, Inc. Built with Docusaurus.</div></div></div></footer></div>
</body>
</html>